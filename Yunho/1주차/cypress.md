# Cypress 활용 E2E 테스트 프로세스 도입

# 개요

 프로젝트가 비교적으로 레거시 코드가 많았기 때문에 프론트엔드 팀 내에선 꾸준한 리팩토링을 필요로 했습니다.  
리팩토링 된 결과물을 개발팀 내에서만 테스트를 진행한다는 건 서비스의 결점을 만드는 것을 초래한다 생각하였고, QA의 테스트 시나리오를 A~Z까지 진행하기에는 QA 팀의 리소스는 한정되어 있었습니다.  

프론트엔드 개발자가 많아질수록 E2E 테스트의 필요성을 더더욱 느끼게 되었습니다. 빠르게 개발되는 새로운 기능에 대해서도 **결점**을 만들지 않도록 하는 테스트 과정이 필요했습니다.  

물론, E2E 테스트 진행한다고 하더라도 QA 팀은 전문성을 가진 팀이기에, TASK에 대한 QA 과정은 필수로 가져가야 합니다. QA 팀에서 작성한 테스트 시나리오 토대로 반복되는 테스트 리소스를 줄이는 것을 목표로 하게 되었습니다.

# 왜 Cypress를 도입하게 되었을까요?

유닛 테스트나 통합 테스트는 모듈의 무결성을 증명할 수 있는 강력한 테스트이지만, 모듈의 무결성이 애플리케이션 동작의 **무결성**까지는 증명해 줄 수 없습니다. 그래서 E2E 테스트 과정에서는 실제 사용자의 시나리오를 테스트함으로써 애플리케이션 동작을 테스트하게 되고, 이 테스트를 통과함으로써 애플리케이션의 무결성을 증명할 수 있게 됩니다.  
E2E 테스트를 수행하는 도구로는 Cypress, Selenium, Playwright 등이 있습니다. 그 중 Cypress는 최근 많이 사용되는 도구로, 비교적 E2E 테스트 프로세스를 간단하게 도입할 수 있도록 해주었습니다.

## Cypress란 무엇인가요?

Cypress는 JavaScript 기반으로 작성된 오픈소스 프론트엔드 테스트 도구로 E2E 테스트에 최적화되어 있습니다. Cypress는 비용을 들이지 않고도 테스트 자동화를 수행할 수 있는 장점을 가지고 있습니다.  
Cypress는 Chrome DevTools Protocol과 WebDriver 프로토콜을 사용하여 웹 브라우저 내에서 웹 어플리케이션을 제어하고, 실제 사용자가 어플리케이션을 사용하는 것과 비슷한 방식으로 테스트를 수행합니다.

## 다른 E2E 테스트 도구와의 비교
앞서 E2E 테스트 도구가 Cypress 외에도 많다고 설명을 했으며, 대표적으로 Selenium, Playwright, Testcafe, NightWatch 등이 있습니다. 대부분 커뮤니티가 작은 반면 Cypress는 
공유되어 있는 이슈가 많기 때문에 테스트 코드 작성이 비교적 편리합니다. 그리고 Cypress는 공식문서를 읽고 바로 간단한 테스트를 실행해볼 수 있을 정도로 예제도 좋으며 간단합니다.   
 PlayWright도 Cypress와 비교했을 때 괜찮다고 생각했지만 PlayWright는 async/await으로 비동기 처리를 하며 작성해야하기 때문에 테스트 코드 양이 늘어나는 반면, Cypress는 비동기로 코드를 작성하지 않아도 내부엔진 의해 비동기 처리 된다는 차이가 있어 Cypress를 선택하게 되었습니다.

## Cypress 도입에 대한 장•단점?

먼저, Cypress는 빠른 테스트 속도와 안정성을 제공합니다. Cypress는 테스트를 수행하는 동안 자동으로 브라우저를 제어하며, 개발자가 테스트 중에 발생하는 모든 이벤트와 상태를 쉽게 확인할 수 있는 디버깅 기능을 제공합니다. 이를 통해 개발자는 테스트가 실패한 이유를 빠르게 파악하고, 수정할 수 있습니다.  

Cypress를 설치하고 테스트 코드를 작성하는 방법을 익힌 후 작성하는 데 까지는 그리 어려운 일이 아닙니다. 심지어는 [Cypress-studio](https://docs.cypress.io/guides/references/cypress-studio) 를 이용해 비개발자도 테스크 코드를 쉽게 작성할 수 있습니다.  

단점으로는 쉬운 도입에 비해 **테스트 코드를 관리하기 어렵다는 부분**이 있습니다.
Cypress 테스트를 수동으로 진행하거나 husky pre-push, 혹은 Github Action에 연동해 테스트가 진행될텐데, 진행 중에 오류가 발생된다면 오류 해결을 위해 Cypress 테스트 코드를 수정해야하는 작업이 필요로 합니다.

또한, 유료 플랜을 사용하지 않는다면 Cypress에서 자체적으로 병렬 테스트를 제공하지 않습니다. 테스트 코드가 늘어날 수록 병렬 테스트를 적용하지 않는다면 Cypress 테스트가 진행되는 시간이 늘어날 수 있습니다.
([Sorry-Cypress](https://docs.sorry-cypress.dev/) 라이브러리를 사용하면 유료 플랜없이 병렬 테스트를 적용할 수 있습니다. 😮)

# 테스트 코드 관리?

프론트엔드 팀에서 ADR(Architectural Decision Records) 회의를 진행하며, Cypress 도입 시점에 Cypress 테스트 코드를 관리하는 방안에 대해 안건으로 두고 논의하였습니다.

- 어디까지 테스트를 할 것인가?

테스트 코드를 작성하고자 하는 화면에서 할 수 있는 모든 사용자 액션을 테스트 코드로 작성하는 것을 목표로 하였습니다. 상품을 장바구니에 담는 테스트를 예로 들면, 상품의 옵션이 단일 옵션인지, 다중 옵션인지, 선택한 해당 옵션이 품절상태인지 모두 확인해 장바구니에 담도록 테스트 코드에 담아야 했습니다.

- 어떻게 테스트 코드를 작성할 것인가?

Cypress 도입함으로써 QA 팀의 테스트 리소스를 줄이기 위한 목표도 있지만, 프론트엔드 개발 과정에서 빠른 피드백을 받기 위함도 있습니다. QA 팀에서 작성한 테스트 시나리오를 토대로 작성하여 개발자가 시나리오를 이해하여 개발을 진행하였는 지 확인할 수 있었습니다.

- 어떻게 테스트 코드를 관리할 것인가?

도메인 단위로 분리 된 개발팀은 각각 도메인 별로 디렉토리를 구분하여 테스트 코드를 꾸준히 관리할 디렉토리를 할당하고, 피쳐 개발을 진행하면서 테스트 코드를 꼭 작성하여 PR을 생성할 것을 약속했습니다.

# 도입 이후

결과적으로, Cypress 도입 이후 새로운 TASK를 진행하며 예기치 못한 버그가 발생하거나 작업자의 개발 소스에 문제가 있었을 경우 바로 찾아 조치를 할 수 있었습니다.  
Cypress 도입 이후 배포 과정에 할당받은 TASK와 별개로 테스트 코드 수정에 대한 리소스를 항상 염두에 두어야 했습니다.  
개인적으로 이것은 **결점**을 개선하기 위한 시행착오를 겪는 것이라 생각합니다. 잘 짜여진 테스트 코드 환경을 구성하고 프로젝트의 기술 부채를 해결해 나간다면 Cypress는 가치있는 테스트 도구라 생각합니다.

